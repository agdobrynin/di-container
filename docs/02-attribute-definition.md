# üîë DiContainer c –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ–º —á–µ—Ä–µ–∑ PHP –∞—Ç—Ä–∏–±—É—Ç—ã

[–í –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞](https://github.com/agdobrynin/di-container/blob/main/docs/01-php-definition.md#–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ_dicontainer) –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø–∞—Ä–∞–º–µ—Ç—Ä `useAttribute` –≤–∫–ª—é—á—ë–Ω.

–ü—Ä–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –º–æ–∂–Ω–æ —Å–æ–≤–º–µ—â–∞—Ç—å php-–∞—Ç—Ä–∏–±—É—Ç—ã –∏ php-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.

> ‚ö† –ü—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–æ–π
> –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∏–º–µ—é—Ç php-–∞—Ç—Ä–∏–±—É—Ç—ã —á–µ–º php-–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.

–î–æ—Å—Ç—É–ø–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã:
- **[Inject](#inject)** - –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞, –º–µ—Ç–æ–¥–∞ –∫–ª–∞—Å—Å–∞.
- **[Service](#service)** - –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∫–∞–∫–æ–π –∫–ª–∞—Å—Å –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω –∏ —Ä–∞–∑—Ä–µ—à–µ–Ω –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ.
- **[DiFactory](#difactory)** - —Ñ–∞–±—Ä–∏–∫–∞ –¥–ª—è c –ø–æ–º–æ—â—å—é –∫–æ—Ç–æ—Ä–æ–π —Ä–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –∫–ª–∞—Å—Å–∞. –ö–ª–∞—Å—Å –¥–æ–ª–∂–µ–Ω —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `Kaspi\DiContainer\Interfaces\DiFactoryInterface`
- **[ProxyClosure](#proxyclosure)** - –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ `\Closure`.

## Inject

–ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –∫–ª–∞—Å—Å–∞, –º–µ—Ç–æ–¥–∞ –∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏–∏.

```php
use Kaspi\DiContainer\Attributes\Inject;

#[Inject(
    id: '', // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–∫–ª–∞—Å—Å, –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞).
            // –ü—Ä–∏ –ø—É—Å—Ç–æ–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å
            // –∑–Ω–∞—á–µ–Ω–∏–µ –∏—Å—Ö–æ–¥—è –∏–∑ —Ç–∏–ø–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–∞.
            // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å id –ø–æ —Ç–∏–ø—É –∞—Ä–≥—É–º–µ–Ω—Ç–∞
            // –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è —Ä–∞–∑—Ä–µ—à–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å
            // –ø–æ –∏–º–µ–Ω–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É—è –∏–º—è –∞—Ä–≥—É–º–µ–Ω—Ç–∞ –∫–∞–∫ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ.
)]
```

### –ê—Ç—Ä–∏–±—É—Ç #[Inject] –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ:

```php
// –û–±—ä—è–≤–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞
use Kaspi\DiContainer\Attributes\Inject;

namespace App;

class MyDb {
    public function __construct(
        #[Inject('services.pdo-env')]
        public \PDO $pdo
    ) {}
}
```
```php
// file config/main.php
use function Kaspi\DiContainer\{diAutowire, diCallable};

return [
    'services.pdo-prod' => diAutowire(PDO::class)
        ->bindArguments(dsn: 'sqlite:/data/prod/db.db'),
    'services.pdo-local' => diAutowire(PDO::class)
        ->bindArguments(dsn: 'sqlite:/tmp/db.db'),
    'services.pdo-env' => diCallable(
        definition: static fn (ContainerInterface $container) => match (\getenv('APP_PDO')) {
            'prod' => $container->get('services.pdo-prod'),
            default => $container->get('services.pdo-local')
        },
        isSingleton: true,
    ),
];
```
```php
// –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.
$container = (new DiContainerFactory())->make(require 'config/main.php');
\putenv('APP_PDO=local');

// ... more code ...

// PDO –±—É–¥–µ—Ç —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ –±–∞–∑—É sqlite:/tmp/db.db'
$myClass = $container->get(App\MyDb::class);
```

### –ê—Ç—Ä–∏–±—É—Ç #[Inject] –¥–ª—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –¥–ª–∏–Ω—ã

–ê—Ç—Ä–∏–±—É—Ç –∏–º–µ–µ—Ç –ø—Ä–∏–∑–Ω–∞–∫ `repetable`

```php
// –û–±—ä—è–≤–ª–µ–Ω–∏—è –∫–ª–∞—Å—Å–æ–≤
use Kaspi\DiContainer\Attributes\Inject;

namespace App\Rules;

interface RuleInterface {}

class RuleA implements RuleInterface {}
class RuleB implements RuleInterface {}

class RuleGenerator {
    private iterable $rules;

    public function __construct(
        #[Inject(RuleB::class)]
        #[Inject(RuleA::class)]
        RuleInterface ...$inputRule
    ) {
        $this->rules = $inputRule;
    }
    
    public function getRules(): array {
        return $this->rules;
    }
}
```
```php
// –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
use Kaspi\DiContainer\Interfaces\DiContainerInterface;
use Kaspi\DiContainer\DiContainerFactory;

$container = (new DiContainerFactory())->make();

// ... more code

$ruleGenerator = $container->get(App\Rules\RuleGenerator::class);

var_dump($ruleGenerator->getRules()[0] instanceof App\Rules\RuleB); // true
var_dump($ruleGenerator->getRules()[1] instanceof App\Rules\RuleA); // true
```

#### –ê—Ç—Ä–∏–±—É—Ç #[Inject] –¥–ª—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –¥–ª–∏–Ω—ã –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

```php
namespace App\Rules;

interface RuleInterface {}

class RuleA implements RuleInterface {}
class RuleB implements RuleInterface {}

class RuleGenerator {
    private iterable $rules;

    public function __construct(
        #[Inject('services.rules.b')]
        #[Inject('services.rules.a')]
        RuleInterface ...$inputRule
    ) {
        $this->rules = $inputRule;
    }
    
    public function getRules(): array {
        return $this->rules;
    }
}
```
```php
// –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
use Kaspi\DiContainer\Interfaces\DiContainerInterface;
use Kaspi\DiContainer\DiContainerFactory;
use Kaspi\DiContainer\{diAutowire, diCallable};

$definitions = [
    'services.rules.a' => diCallable(
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–Ω–µ–¥—Ä–∏—Ç –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —ç—Ç–æ–π callback —Ñ—É–Ω–∫—Ü–∏–∏
        static function (App\Rules\RuleA $a) {
            // —Ç—É—Ç –≤–æ–∑–º–æ–∂–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—ä–µ–∫—Ç–∞
            return $a
        }
    ),
    'services.rules.b' => diAutowire(App\Rules\RuleB::class),
];

$container = (new DiContainerFactory())->make($definitions);

// ... more code

$ruleGenerator = $container->get(App\Rules\RuleGenerator::class);

var_dump($ruleGenerator->getRules()[0] instanceof App\Rules\RuleB); // true
var_dump($ruleGenerator->getRules()[1] instanceof App\Rules\RuleA); // true
```

### –ê—Ç—Ä–∏–±—É—Ç #[Inject] –∏ –∫–ª–∞—Å—Å —Ä–µ–∞–ª–∏–∑—É—é—â–∏–π DiFactoryInterface
–ö–ª–∞—Å—Å —Ä–µ–∞–ª–∏–∑—É—é—â–∏–π `Kaspi\DiContainer\Interfaces\DiFactoryInterface` –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º –∏ –∏—Å–ø–æ–ª–Ω–µ–Ω –º–µ—Ç–æ–¥ `__invoke`
–∫–æ—Ç–æ—Ä—ã–π —è–≤–ª—è–µ—Ç—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –¥–ª—è Inject –∞—Ç—Ä–∏–±—É—Ç–∞.

–ü—Ä–∏–º–µ—Ä –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –¥–ª–∏–Ω–Ω—ã:
```php
// –û–±—ä—è–≤–ª–µ–Ω–∏—è –∫–ª–∞—Å—Å–æ–≤
use Kaspi\DiContainer\Attributes\Inject;
use Kaspi\DiContainer\Interfaces\DiFactoryInterface;

namespace App\Rules;

interface RuleInterface {}
class RuleA implements RuleInterface {}
class RuleB implements RuleInterface {}

class RulesDiFactory implements DiFactoryInterface {
    public function __construct(
        private RuleA $ruleA,
    ) {}

    public function __invoke(ContainerInterface $container): RuleA {
        // —Ç—É—Ç –≤–æ–∑–º–æ–∂–Ω—ã –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±—ä–µ–∫—Ç–∞ ruleA
        return $this->ruleA;
    }
}

class RuleGenerator {
    private iterable $rules;

    public function __construct(
        #[Inject(RuleB::class)]
        #[Inject(RulesDiFactory::class)]
        RuleInterface ...$inputRule
    ) {
        $this->rules = $inputRule;
    }
    
    public function getRules(): array {
        return $this->rules;
    }
}
```
```php
// –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
use Kaspi\DiContainer\Interfaces\DiContainerInterface;
use Kaspi\DiContainer\DiContainerFactory;

$container = (new DiContainerFactory())->make();

// ... more code

$ruleGenerator = $container->get(App\Rules\RuleGenerator::class);

var_dump($ruleGenerator->getRules()[0] instanceof App\Rules\RuleB); // true
var_dump($ruleGenerator->getRules()[1] instanceof App\Rules\RuleA); // true
```

### –ê—Ç—Ä–∏–±—É—Ç **#[Inject]** –ø—Ä–∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–∏ –∫–ª–∞—Å—Å–∞ –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.

```php
// –û–±—ä—è–≤–ª–µ–Ω–∏—è –∫–ª–∞—Å—Å–æ–≤
namespace App\Rules;

interface RuleInterface {}

class RuleA implements RuleInterface {}

class RuleGenerator {
    public function __construct(
        #[Inject(RuleA::class)]
        public RuleInterface $inputRule
    ) {}
}
```
```php
// –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
use Kaspi\DiContainer\DiContainerFactory;

$container = (new DiContainerFactory())->make();

// ... more code

$ruleGenerator = $container->get(App\Rules\RuleGenerator::class);

var_dump($ruleGenerator->inputRule instanceof App\Rules\RuleA); // true
```

## Service

–ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É.

```php
use Kaspi\DiContainer\Attributes\Service;

#[Service(
    id: '', // –ö–ª–∞—Å—Å —Ä–µ–∞–ª–∏–∑—É—é—â–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            // –∏–ª–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.
)]
```

```php
// –û–±—ä—è–≤–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–æ–≤
use Kaspi\DiContainer\Attributes\InjectByReference;
use Kaspi\DiContainer\Attributes\Inject;
use Kaspi\DiContainer\Attributes\Service;

namespace App;

#[Service(CustomLogger::class)] // –∫–ª–∞—Å—Å —Ä–µ–∞–ª–∏–∑—É—é—â–∏–π –¥–∞–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
interface CustomLoggerInterface {
    public function loggerFile(): string;
}

// –ö–ª–∞—Å—Å —Ä–µ–∞–ª–∏–∑—É—é—â–∏–π CustomLoggerInterface.

class CustomLogger implements CustomLoggerInterface {
    public function __construct(
        protected string $file,
    ) {}
    
    public function loggerFile(): string {
        return $this->file;
    }
}

// –ö–ª–∞—Å—Å –≤–Ω–µ–¥—Ä—è—é—â–∏–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å –ø–æ CustomLoggerInterface

class MyLogger {
    public function __construct(
        // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞–π–¥—ë—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        // –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç —É –Ω–µ–≥–æ php-–∞—Ç—Ä–∏–±—É—Ç Service.
        public CustomLoggerInterface $customLogger
    ) {}
}
```

```php
// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–ª—è DiContainer
use Kaspi\DiContainer\DiContainerFactory;
use function Kaspi\DiContainer\diAutowire;

$definitions = [
    diAutowire(App\CustomLogger::class)
        // üåû –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –≤ –ø–∞—Ä–∞–º–µ—Ç—Ä $file –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ.
        ->bindArguments(file: '/var/log/app.log')
];

$container = (new DiContainerFactory())->make($definitions);
```

```php
// –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
$myClass = $container->get(App\MyLogger::class);
print $myClass->customLogger->loggerFile(); // /var/log/app.log
```

–¢–∞–∫ –∂–µ –∞—Ç—Ä–∏–±—É—Ç Service –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–æ —Å—Å—ã–ª–∫–æ–π –Ω–∞ –¥—Ä—É–≥–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.
```php
use Kaspi\DiContainer\Attributes\Service;
use Kaspi\DiContainer\DiContainerFactory;
use Kaspi\DiContainer\diCallable;

#[Service('services.my-srv')] // üîÉ –ü–æ–ª—É—á–∏—Ç—å –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
interface MyInterface {}

// ...

class SuperClass {
    public function __construct(public MyInterface $my) {}
}

// ...

class SuperSrv implements MyInterface {
    public function changeConfig(array $config) {
        //...
    }
}

// ...
$definitions = [
    'services.my-srv' => diCallable(static function (SuperSrv $srv) {
        $srv->changeConfig([...]); // –∫–∞–∫–∏–µ-—Ç–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.
        
        return $srv; // –≤–µ—Ä–Ω—É—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å.
    }),
];

$container = (new DiContainerFactory())->make($definitions);

$container->get(SuperClass::class); 
```

## DiFactory
–ü—Ä–∏–º–µ–Ω—è—Ç—Å—è –∫ –∫–ª–∞—Å—Å—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.
```php
use Kaspi\DiContainer\Attributes\DiFactory;

#[DiFactory(
    id: '', // –ö–ª–∞—Å—Å —Ä–µ–∞–ª–∏–∑—É—é—â–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Kaspi\DiContainer\Interfaces\DiFactoryInterface
    isSingleton: false,  // —Å–µ—Ä–≤–∏—Å —Å–æ–∑–¥–∞—ë—Ç—Å—è –∫–∞–∫ Singleton
)]
```

```php
// –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞
use Kaspi\DiContainer\Attributes\DiFactory

namespace App;

// –†–∞–∑—Ä–µ—à–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ —Ñ–∞–±—Ä–∏–∫—É –∏ —É–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É —á—Ç–æ —ç—Ç–æ –±—É–¥–µ—Ç Singleton.
#[DiFactory(App\Factory\FactorySuperClass::class, isSingleton: true)]
class SuperClass
{
    public function __construct(public string $name, public int $age) {}
}
```

```php
// –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–∞–±—Ä–∏–∫–∏
namespace App\Factory;

use Kaspi\DiContainer\Interfaces\DiFactoryInterface;
use Psr\Container\ContainerInterface;

class FactorySuperClass implements DiFactoryInterface
{
    public function __invoke(ContainerInterface $container): App\SuperClass
    {
        return new App\SuperClass('Piter', 22);
    }
}
```

```php
// –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–≤—è–∑—ã–≤–∞–Ω–∏–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
use App\SuperClass;

$container = (new DiContainerFactory())->make();

$myClass = $container->get(SuperClass::class);
print $myClass->name; // Piter
print $myClass->age; // 22
```
## ProxyClosure

–†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ª–µ–Ω–∏–≤–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫–ª–∞—Å—Å–∞ (–∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏) —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é –æ–±—Ä–∞—Ç–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞.

```php
use Kaspi\DiContainer\Attributes\ProxyClosure;

#[ProxyClosure(
    id: '', // –ö–ª–∞—Å—Å —Ä–µ–∞–ª–∏–∑—É—é—â–∏–π —Å–µ—Ä–≤–∏—Å –∫–æ—Ç–æ—Ä—ã–π –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ
    isSingleton: false,  // —Å–µ—Ä–≤–∏—Å —Å–æ–∑–¥–∞—ë—Ç—Å—è –∫–∞–∫ Singleton
)]
```

–¢–∞–∫–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–∞ –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è –¥–ª—è ¬´—Ç—è–∂—ë–ª—ã—Ö¬ª –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π, —Ç—Ä–µ–±—É—é—â–∏—Ö –¥–ª–∏—Ç–µ–ª—å–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–ª–∏ —Ä–µ—Å—É—Ä—Å–æ—ë–º–∫–∏—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π.

> –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è [ProxyClosure](https://github.com/agdobrynin/di-container/blob/main/docs/01-php-definition.md#diproxyclosure)

–ü—Ä–∏–º–µ—Ä –¥–ª—è –æ—Ç–ª–æ–∂–µ–Ω–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–µ—Ä–≤–∏—Å–∞ —á–µ—Ä–µ–∑ –∞—Ç—Ä–∏–±—É—Ç `#[ProxyClosure]`:

```php
// –ö–ª–∞—Å—Å —Å ¬´—Ç—è–∂—ë–ª—ã–º–∏¬ª –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏, –º–Ω–æ–≥–æ —Ä–µ—Å—É—Ä—Å–æ–≤ –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é.
namespace App\Services;

use Kaspi\DiContainer\Attributes\ProxyClosure;

class HeavyDependency {
    public function __construct(...) {}
    public function doMake() {}
}

class ClassWithHeavyDependency {
    /**
     * @param Closure(): HeavyDependency $heavyDependency
     */
    public function __construct(
        /**
         * üö© –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è IDE –ø—Ä–∏ –∞–≤—Ç–æ-–¥–æ–ø–æ–ª–µ–Ω–∏–∏ (autocomplete).
         * @param Closure(): HeavyDependency $heavyDependency
         */
        #[ProxyClosure(HeavyDependency::class)]
        private \Closure $heavyDependency,
        private LiteDependency $liteDependency,
    ) {}
    
    public function doHeavyDependency() {
        ($this->heavyDependency)()->doMake();
    }
    
    public function doLiteDependency() {
        $this->liteDependency->doMakeLite();
    }
}
```

> üìù –î–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ IDE autocomplete –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ
> PhpDocBlock –Ω–∞–¥ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–æ–º: 
> `@param Closure(): HeavyDependency $heavyDependency`

```php
use Kaspi\DiContainer\DiContainerFactory;

$container = (new DiContainerFactory())->make();

// —Å–≤–æ–π—Å—Ç–≤–æ ClassWithHeavyDependency::$heavyDependency
// –µ—â—ë –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ.
$classWithHeavyDependency = $container->get(App\Services\ClassWithHeavyDependency::class);

// –í–Ω—É—Ç—Ä–∏ –º–µ—Ç–æ–¥–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è
// —Å–≤–æ–π—Å—Ç–≤–æ ClassWithHeavyDependency::$heavyDependency
// —á–µ—Ä–µ–∑ Closure –≤—ã–∑–æ–≤ (callback —Ñ—É–Ω–∫—Ü–∏—è) 
$classWithHeavyDependency->doHeavyDependency();
```

## –ü—Ä–∏–º–µ—Ä #1

–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ callback —Ñ—É–Ω–∫—Ü–∏–∏:
```php
namespace App\Rules;

interface RuleInterface {}

class RuleA implements RuleInterface {}
class RuleB implements RuleInterface {}
```
```php
namespace App\Services;

use App\Rules\RuleInterface;
use Kaspi\DiContainer\Attributes\Inject;

class IterableArg
{
    /**
     * @param RuleInterface[] $rules
     */
    public function __construct(
        #[Inject('services.rule-list')]
        private iterable $rules
    ) {}
}
```
```php
use App\Rules\{RuleA, RuleB}; 
use App\Services\IterableArg;
use Kaspi\DiContainer\DiContainerFactory;

$container = (new DiContainerFactory())->make([
    'services.rule-list' => static fn (RuleA $a, RuleB $b) => \func_get_args(),
]);

$class = $container->get(IterableArg::class);
```
> üìù –ï—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è —á—Ç–æ–±—ã —Å–µ—Ä–≤–∏—Å `services.rule-list` –±—ã–ª –æ–±—ä—è–≤–ª–µ–Ω –∫–∞–∫ `isSingleton`
> –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é-—Ö—ç–ª–ø–µ—Ä `diCallable`
> ```php
> $definitions = [
>   'services.rule-list' => diCallable(
>       definition: static fn (RuleA $a, RuleB $b) => \func_get_args(),
>       isSingleton: true
>   ),
> ];
> ```
